{"version":3,"file":"snapshot.js","names":["snapshotWebsite","options","snapshot","transformContent","content","reloadData","addReloadDataFlag","host","port","pages","outputPath","unshift","snapshotProgress","ProgressBar","complete","incomplete","width","total","length","snapshotPages","tick","fs","moveSync","path","join","removeSync","remove","page","snapshotPage","url","targetStatusCode","status","_url","download","Error","outputFileSync","headEndsAt","indexOf","slice"],"sources":["../../lib/static-site-generator/snapshot.js"],"sourcesContent":["import path from 'path'\r\nimport fs from 'fs-extra'\r\nimport ProgressBar from 'progress'\r\n\r\nimport download from './download.js'\r\n\r\n// Snapshots all pages (URLs).\r\nexport default async function snapshotWebsite(options) {\r\n\treturn snapshot({\r\n\t\t...options,\r\n\t\ttransformContent: (content) => {\r\n\t\t\tif (options.transformContent) {\r\n\t\t\t\tcontent = options.transformContent(content)\r\n\t\t\t}\r\n\t\t\tif (options.reloadData) {\r\n\t\t\t\tcontent = addReloadDataFlag(content)\r\n\t\t\t}\r\n\t\t\treturn content\r\n\t\t}\r\n\t})\r\n}\r\n\r\n// Snapshots all pages (URLs).\r\nexport async function snapshot({\r\n\thost,\r\n\tport,\r\n\tpages,\r\n\toutputPath,\r\n\ttransformContent\r\n}) {\r\n\t// Could be `null`, not just `undefined`.\r\n\tif (!pages) {\r\n\t\tpages = []\r\n\t}\r\n\r\n\t// Add the \"base\" page which is an empty page\r\n\t// which will be rendered in user's browser on client side.\r\n\t// This should be the \"fallback\" page.\r\n\tpages.unshift('/react-pages-base')\r\n\r\n\t// The progress meter for the website snapshotting process.\r\n\tconst snapshotProgress = new ProgressBar(' Snapshotting [:bar] :total :percent :etas', {\r\n\t\tcomplete: '=',\r\n\t\tincomplete: ' ',\r\n\t\twidth: 50,\r\n\t\ttotal: pages.length\r\n\t})\r\n\r\n\t// Start the website snapshotting process\r\n\tawait snapshotPages(\r\n\t\thost,\r\n\t\tport,\r\n\t\tpages,\r\n\t\toutputPath,\r\n\t\ttransformContent,\r\n\t\t() => snapshotProgress.tick()\r\n\t)\r\n\r\n\t// Move `./react-pages-base/index.html` to `./base.html`.\r\n\tfs.moveSync(path.join(outputPath, 'react-pages-base/index.html'), path.join(outputPath, 'base.html'))\r\n\tfs.removeSync(path.join(outputPath, 'react-pages-base'))\r\n}\r\n\r\nasync function snapshotPages(host, port, pages, outputPath, transformContent, tick) {\r\n\t// Clear the output folder\r\n\tawait fs.remove(outputPath)\r\n\t// Snapshot every page and put it into the output folder\r\n\tfor (const page of pages) {\r\n\t\tawait snapshotPage(host, port, page, outputPath, transformContent)\r\n\t\ttick()\r\n\t}\r\n}\r\n\r\nasync function snapshotPage(host, port, page, outputPath, transformContent) {\r\n\t\tlet url = page\r\n\t\tlet targetStatusCode = 200\r\n\r\n\t\tif (typeof page !== 'string' && page.status) {\r\n\t\t\turl = page.url\r\n\t\t\ttargetStatusCode = page.status\r\n\t\t}\r\n\r\n\t\tconst _url = `http://${host}:${port}${url}`\r\n\t\tconst { status, content } = await download(_url)\r\n\r\n\t\tif (status !== targetStatusCode) {\r\n\t\t\tthrow new Error(`Expected ${targetStatusCode} HTTP status code for \"${_url}\". Got ${status}.`);\r\n\t\t}\r\n\r\n\t\tfs.outputFileSync(path.join(outputPath, url, '/index.html'), transformContent ? transformContent(content) : content)\r\n}\r\n\r\nfunction addReloadDataFlag(content) {\r\n\tconst headEndsAt = content.indexOf('</head>')\r\n\tif (headEndsAt < 0) {\r\n\t\tthrow new Error('</head> not found')\r\n\t}\r\n\treturn content.slice(0, headEndsAt) +\r\n\t\t'<script> window._ReactPages_Page_ReloadDataOnClientRender = true </script>' +\r\n\t\tcontent.slice(headEndsAt)\r\n}"],"mappings":"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"}