{"version":3,"file":"server.js","names":["server","settings","options","initialize","Error","secure","https","http","createServer","request","response","respondWithPage","error","respondWithError","printError","renderPage","url","headers","redirect","cookies","status","content","writeHead","Location","end","cookie","setHeader","pipe","proxy","assets","renderContent","html","stats","getInitialState","parse","render","locales","getPreferredLocales","route","time","newCookies","renderError","contentType"],"sources":["../../lib/server/server.js"],"sourcesContent":["import http from 'http'\r\nimport https from 'https'\r\nimport cookie from 'cookie'\r\n\r\nimport render from './render.js'\r\nimport renderError from './renderError.js'\r\nimport timer from '../timer.js'\r\nimport { getPreferredLocales } from './locale.js'\r\n\r\nexport default function server(settings, options)\r\n{\r\n\tif (options.initialize) {\r\n\t\tthrow new Error('[react-pages] \"initialize\" server-side parameter function was removed. Use a root-level `load` instead.')\r\n\t}\r\n\treturn (options.secure ? https : http).createServer((request, response) => {\r\n\t\t// Render the page (and handle errors, if any)\r\n\t\trespondWithPage(request, response, settings, options)\r\n\t\t\t.catch((error) => respondWithError(error, response, options.printError))\r\n\t})\r\n}\r\n\r\n// Renders a webpage\r\nasync function respondWithPage(request, response, settings, options)\r\n{\r\n\tconst {\r\n\t\tredirect,\r\n\t\tcookies,\r\n\t\tstatus,\r\n\t\tcontent\r\n\t} = await renderPage(request.url, request.headers, settings, options)\r\n\r\n\tif (redirect) {\r\n\t\tresponse.writeHead(302, { Location: redirect })\r\n\t\treturn response.end()\r\n\t}\r\n\r\n\t// `cookies` is a `Set`, not an `Array`,\r\n\t// hence the `for` loop.\r\n\tfor (const cookie of cookies) {\r\n\t\tresponse.setHeader('Set-Cookie', cookie)\r\n\t}\r\n\r\n\t// HTTP response status and \"Content-Type\"\r\n\tresponse.writeHead(status || 200, { 'Content-Type': 'text/html' })\r\n\r\n\t// Stream the rendered React page\r\n\tcontent.pipe(response)\r\n}\r\n\r\n// Renders a webpage.\r\n// `headers`: `{ cookie, accept-language, host, user-agent }`.\r\nexport async function renderPage(url, headers, settings, options)\r\n{\r\n\tconst {\r\n\t\tsecure,\r\n\t\tproxy,\r\n\t\tassets,\r\n\t\trenderContent,\r\n\t\thtml,\r\n\t\tstats,\r\n\t\tgetInitialState\r\n\t} = options\r\n\r\n\tconst cookies = headers.cookie ? cookie.parse(headers.cookie) : {}\r\n\r\n\tlet {\r\n\t\tstatus,\r\n\t\tcontent,\r\n\t\tredirect,\r\n\t\troute,\r\n\t\ttime,\r\n\t\tcookies: newCookies\r\n\t} = await render(settings, {\r\n\t\tproxy,\r\n\t\tassets,\r\n\t\trenderContent,\r\n\t\thtml,\r\n\t\turl,\r\n\t\t// Cookies for making `http` requests on server.\r\n\t\tcookies,\r\n\t\tlocales: getPreferredLocales(headers),\r\n\t\t// Headers are used in `getInitialState()`.\r\n\t\t// https://github.com/catamphetamine/react-website/issues/72\r\n\t\tgetInitialState,\r\n\t\theaders\r\n\t})\r\n\r\n\t// If a redirect happened perform an HTTP redirect\r\n\tif (redirect) {\r\n\t\t// No need to convert a relative URL to an absolute URL:\r\n\t\t// since June 2014 the RFC permits redirection to relative URLs.\r\n\t\t// https://stackoverflow.com/questions/8250259/is-a-302-redirect-to-relative-url-valid-or-invalid\r\n\t\t// // Convert relative URL to an absolute one\r\n\t\t// if (redirect[0] === '/') {\r\n\t\t// \tredirect = `${secure ? 'https' : 'http'}://${headers.host}${redirect}`;\r\n\t\t// }\r\n\t\treturn { redirect }\r\n\t}\r\n\r\n\t// Report page rendering stats\r\n\tif (stats) {\r\n\t\tstats({\r\n\t\t\turl,\r\n\t\t\troute,\r\n\t\t\ttime\r\n\t\t})\r\n\t}\r\n\r\n\treturn {\r\n\t\tcookies: newCookies,\r\n\t\tstatus,\r\n\t\tcontent\r\n\t}\r\n}\r\n\r\nfunction respondWithError(error, response, options)\r\n{\r\n\tconst { status, content, contentType } = renderError(error, options)\r\n\r\n\t// HTTP response status and \"Content-Type\"\r\n\tresponse.writeHead(status, { 'Content-Type': contentType })\r\n\r\n\t// Output the error page\r\n\treturn response.end(content)\r\n}"],"mappings":"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"}